

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Defining commands &mdash; Zimagi 0.5.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/override.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #021026" >
          
            
          <div class="logo"><span class="sr-only">Zimagi</span></div>

          

          

          
          <a href="../readme.html" class="icon icon-home"><span class="name">Zimagi</span>
          
          </a>
          <span class="description">Distributed Data Processing Platform
            
              
              
              <span class="version">
                (0.5.1)
              </span>
              
            
          </span>


          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://zimagi.com">Zimagi Site</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zimagi/zimagi/">GitHub Project</a></li>
</ul>
<p><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/readme.html">Getting Started with Zimagi</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/use_module.html">Using Zimagi Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/use_module.html#installing-zimagi">Installing Zimagi</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting_started/use_module.html#cloning-the-zimagi-repo">Cloning the Zimagi Repo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting_started/use_module.html#configuring-the-environment">Configuring the environment</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/commands.html">The Command Line Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/commands.html#config-commands">Config Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/commands.html#environment-commands">Environment Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/commands.html#database-commands">Database Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/commands.html#schedule-commands">Schedule Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/commands.html#data-import-commands">Data Import Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/commands.html#user">User</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/vagrant.html">Launching Vagrant containers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started/vagrant.html#when-things-go-wrong">When things go wrong</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting_started/vagrant.html#dependencies">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting_started/vagrant.html#ports">Ports</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting_started/vagrant.html#recovery">Recovery</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../readme.html"><span>Zimagi</span> - <span class="description">Distributed Data Processing Platform</span></a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div class="breadcrumbs" role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../readme.html">Docs</a> &raquo;</li>
        
      <li>Defining commands</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/creating_a_zimagi_module/commands.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="defining-commands">
<h1>Defining commands<a class="headerlink" href="#defining-commands" title="Permalink to this headline">¶</a></h1>
<p>The final step in being able to actually <em>use</em> the data objects we have
configured is define Zimagi commands to import their data and query them.  By
adding a <code class="docutils literal notranslate"><span class="pre">station</span></code> command, we automatically add a collection of subcommands
associated with querying data.</p>
<p>As elsewhere, we often wish to define a reusable <code class="docutils literal notranslate"><span class="pre">command_base</span></code> that might be
utilized by various commands to avoid repetition.  In this module, we define the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command_base</span><span class="p">:</span>
  <span class="c1"># Define a base command with settings</span>
  <span class="c1"># Same name as data model by convention, not requirement</span>
  <span class="n">station_base</span><span class="p">:</span>
    <span class="n">class</span><span class="p">:</span> <span class="n">StationCommandBase</span>
    <span class="n">mixins</span><span class="p">:</span> <span class="p">[</span><span class="n">station</span><span class="p">]</span>
    <span class="c1"># Accessible via the API</span>
    <span class="n">server_enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="c1"># Only these groups can use &#39;station&#39; commands</span>
    <span class="n">groups_allowed</span><span class="p">:</span> <span class="p">[</span><span class="n">noaa</span><span class="o">-</span><span class="n">admin</span><span class="p">]</span>
</pre></div>
</div>
<p>The particular name we chose for this command base is anything we might wish,
but <code class="docutils literal notranslate"><span class="pre">station_base</span></code> seems like an obvious choice.  It has an (optional)
internal class name in the generated code, and it uses the mixin we discussed
earlier.  The two elements where we actually make design decisions are in that
we wish to expose commands based on this within the RESTful JSON API (i.e. for
web requrests), and that we want the role <code class="docutils literal notranslate"><span class="pre">noaa-admin</span></code> to be able to use it.</p>
<p>We gave the base an (optional) internal class name in the generated code, and
it uses the mixin we discussed earlier. The only elements where we actually
make design decisions are <code class="docutils literal notranslate"><span class="pre">server_enabled</span></code> and <code class="docutils literal notranslate"><span class="pre">groups_allowed</span></code>.</p>
<p>We set <code class="docutils literal notranslate"><span class="pre">server_enabled</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> to expose commands within the RESTful
JSON API (i.e. for web requests). We also give the <code class="docutils literal notranslate"><span class="pre">groups_allowed</span></code> key the
role that we want to be able to use: <code class="docutils literal notranslate"><span class="pre">noaa-admin</span></code>.</p>
<p>We need an actual command here.  To show that the names of the commands are
chosen by use, rather than constrained by the name of the data object or by
mixins, we defined too almost-synonyms.  Both <code class="docutils literal notranslate"><span class="pre">station</span></code> subcommands and
<code class="docutils literal notranslate"><span class="pre">bahnhof</span></code> subcommands will do the same thing (“Bahnhof” is simply a German
word for “station”):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command</span><span class="p">:</span>
  <span class="n">station</span><span class="p">:</span>
    <span class="c1"># Maps back to data object</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">station</span>
    <span class="n">base</span><span class="p">:</span> <span class="n">station_base</span>
    <span class="c1"># Show later than core commands</span>
    <span class="n">priority</span><span class="p">:</span> <span class="mi">99</span>
    <span class="n">groups_allowed</span><span class="p">:</span> <span class="p">[</span><span class="n">noaa</span><span class="o">-</span><span class="n">admin</span><span class="p">,</span> <span class="n">admin</span><span class="p">]</span>

  <span class="c1"># Alternate command (does same thing to demonstrate)</span>
  <span class="n">bahnhof</span><span class="p">:</span>
    <span class="c1"># Maps back to data object</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">station</span>
    <span class="n">base</span><span class="p">:</span> <span class="n">station_base</span>
    <span class="c1"># Tie into object type (to match prefix for mixin)</span>
    <span class="c1"># I.e. match ref mixin_name</span>
    <span class="n">base_name</span><span class="p">:</span> <span class="n">station</span>
    <span class="c1"># Show later than core commands</span>
    <span class="n">priority</span><span class="p">:</span> <span class="mi">98</span>
</pre></div>
</div>
<p>The only differences here, other than the obvious spelling, is that we
demonstrate that a command may override its base; in this case we redefine
<code class="docutils literal notranslate"><span class="pre">groups_allowed</span></code> for the <code class="docutils literal notranslate"><span class="pre">station</span></code> command.  This is not a real change in
behavior since <em>admin</em> is always allowed to do everything anyway.  We also
choose slightly different <code class="docutils literal notranslate"><span class="pre">priority</span></code> values for the two spellings, which will
cause <code class="docutils literal notranslate"><span class="pre">bahnhof</span></code> to appear earlier than <code class="docutils literal notranslate"><span class="pre">station</span></code> when you run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@zimagi-noaa:~$ zimagi help
</pre></div>
</div>
<p>Inside the Vagrant shell.  As the module is configured now, the <code class="docutils literal notranslate"><span class="pre">observation</span></code>
priority is even higher (105), so appears after both.</p>
<section id="import-commands">
<h2>Import commands<a class="headerlink" href="#import-commands" title="Permalink to this headline">¶</a></h2>
<p>We have provided a <code class="docutils literal notranslate"><span class="pre">station</span></code> (or <code class="docutils literal notranslate"><span class="pre">bahnhof</span></code>) command as a place to put
subcommands we use in querying data.  But we need to define an <code class="docutils literal notranslate"><span class="pre">import</span></code>
subcommand to load the data from our remote source(s) into the local RDBMS.</p>
<p>For this module, we define that inside
<code class="docutils literal notranslate"><span class="pre">$ZDIR/lib/modules/default/noaa-stations/spec/import/station_observations.yml</span></code>.</p>
<p>This YAML file includes a new YAML feature we have not seen before.  Using
mixins and bases for commands and data models is a way of providing templates
for reuse.</p>
<p>As well, YAML itself has a feature for literal transclusion of boilerplate.
This distinction is very similar to the difference between an <code class="docutils literal notranslate"><span class="pre">#include</span></code>
directive in languages like C/C++ and <em>inheritance</em> of classes in languages
like Python (or C++, or Java, etc).  For better or worse, because <code class="docutils literal notranslate"><span class="pre">import</span></code> is
a built-in Zimagi command, we can define subcommands but not new bases or
mixins for it.</p>
<p>The YAML feature we see is called <em>anchors</em> and <em>aliases</em>.  They always occur
in the same physical file, so are somewhat different from C-style <code class="docutils literal notranslate"><span class="pre">#include</span></code>
directives in that respect.  Let us look first at the anchor we use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_observation</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">observation</span>
  <span class="n">source</span><span class="p">:</span> <span class="n">noaa_stations</span>
  <span class="n">data</span><span class="p">:</span>
    <span class="n">station</span><span class="p">:</span>
      <span class="nb">map</span><span class="p">:</span>
        <span class="c1"># &quot;number&quot; as defined in spec/data/station.yml</span>
        <span class="n">number</span><span class="p">:</span>
          <span class="c1"># &quot;station_id&quot; as defined in plugins/source/noaa_stations.py</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">station_id</span>
        <span class="n">name</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">station_name</span>
        <span class="n">lat</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">latitude</span>
        <span class="n">lon</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">longitude</span>
        <span class="n">elevation</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">elevation</span>

    <span class="n">observation</span><span class="p">:</span>
      <span class="n">relations</span><span class="p">:</span>
        <span class="n">station_id</span><span class="p">:</span>
          <span class="c1"># Mapping back to &quot;station&quot; as defined in spec/data/station.yml</span>
          <span class="n">data</span><span class="p">:</span> <span class="n">station</span>
          <span class="c1"># Mapping back to plugins/source/noaa_stations.py</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">station_id</span>
          <span class="n">required</span><span class="p">:</span> <span class="n">true</span>
      <span class="nb">map</span><span class="p">:</span>
        <span class="n">date</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">date</span>
        <span class="n">temp</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">temperature</span>
        <span class="n">temp_attrs</span><span class="p">:</span>
          <span class="n">column</span><span class="p">:</span> <span class="n">temperature_attrs</span>
</pre></div>
</div>
<p>This anchor is something we are likely to use as we develop more commands.  It
has an anchor name <code class="docutils literal notranslate"><span class="pre">&amp;observation</span></code>, but as we will see, when we <em>alias</em> it
we will spell that as <code class="docutils literal notranslate"><span class="pre">*observation</span></code> (these spelling are loosely inspired by
references and pointers in C/C++ family languages).  The name of the key with
a leading underscore, <code class="docutils literal notranslate"><span class="pre">_observation</span></code> is irrelevant—you can use any identifier
name you like, and it is not used again elsewhere; something merely needs to
occur there syntactically.</p>
<p>We indicate the source in terms of a <em>provider</em>. Recall the definition in
<code class="docutils literal notranslate"><span class="pre">spec/plugins/source.yml</span></code> that was discussed above; this is where the spelling
<code class="docutils literal notranslate"><span class="pre">noaa_stations</span></code> comes from.  Given that source, we define <code class="docutils literal notranslate"><span class="pre">data</span></code> import
elements <code class="docutils literal notranslate"><span class="pre">station</span></code> and <code class="docutils literal notranslate"><span class="pre">observation</span></code>.  These each have a <code class="docutils literal notranslate"><span class="pre">map</span></code> key that
maps database table column names to names used within the Zimagi shell and
API.  They might also have a <code class="docutils literal notranslate"><span class="pre">relations</span></code> key that defines a foreign-key
relationship.</p>
<p>The final component of our (simple) module is define an actual <code class="docutils literal notranslate"><span class="pre">import</span></code>
subcommand.  We can do that as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">import</span><span class="p">:</span>
  <span class="n">test</span><span class="p">:</span>
    <span class="c1"># Identical to including the body of _observation here</span>
    <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">observation</span>
    <span class="c1"># In concept we could override definition from reference, e.g.</span>
    <span class="c1"># source: something_else</span>
    <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">observations</span><span class="p">]</span>
    <span class="n">min_year</span><span class="p">:</span> <span class="mi">1929</span>
    <span class="n">max_year</span><span class="p">:</span> <span class="mi">1931</span>
    <span class="n">station_ids</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;03005099999&quot;</span><span class="p">,</span> <span class="s2">&quot;99006199999&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The special key <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> is the one that indicates an alias back to the anchor
defined above.  It is exactly as if we had typed the entire body of
<code class="docutils literal notranslate"><span class="pre">_observation</span></code> at that same point in the file</p>
<p>The key <code class="docutils literal notranslate"><span class="pre">tags</span></code> indicates <strong>[TODO]</strong>.</p>
<p>For this simple subcommand <code class="docutils literal notranslate"><span class="pre">test</span></code> we give a fixed value for a <code class="docutils literal notranslate"><span class="pre">min_year</span></code> and
<code class="docutils literal notranslate"><span class="pre">max_year</span></code>, and also a specific list of <code class="docutils literal notranslate"><span class="pre">station_ids</span></code> that we will import
from the NOAA website.  In a more flexible command, you would indicate these
elements using switches to a command, but this demonstrates the general pattern.</p>
<p>At this point—perhaps after running <code class="docutils literal notranslate"><span class="pre">zimagi</span> <span class="pre">module</span> <span class="pre">save</span> <span class="pre">noaa-stations</span></code> again,
if needed, we can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@zimagi-noaa:~$  zimagi import test
</pre></div>
</div>
<p>Data is available locally to be queried from the Vagrant shell or the API now.</p>
</section>
</section>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Zimagi

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>

  
  
    
   

</body>
</html>